# Ejemplo con C#
## Suponemos que ya tenemos esto en `Program.cs`
- *si no, mirar la explicación 01.a*
    ~~~csharp
    // Servicio de HttpContext.Session
    builder.Services.AddDistributedMemoryCache();
    builder.Services.AddSession(options =>
    {
        options.IdleTimeout = TimeSpan.FromMinutes(30);
        options.Cookie.HttpOnly = true;
        options.Cookie.IsEssential = true;
        options.Cookie.Name = "MiCookie";
    });
    ~~~

## Creamos un Controller para añadir los endpoints
- Creamos un endpoint para añadir un dato a la cookie
- Creamos un endpoint para añadir varios datos a la cookie
    - Aunque se añadan varios datos, se guardan y se irán añadiendo a la misma `cookie`
- Creamos un endpoint para añadir varios datos en un objeto json
    - Habrá que `Serialize` para setearlo (`HttpContext.Session.SetString("Usuario", usuarioJson)`)
    - Habrá que `Deserialize` para obtenerlo (`HttpContext.Session.GetString("Usuario")`)

## Ejemplos de un `Controller` con `HttpContext.Session`
~~~csharp
using httponly.DTOs;
using Microsoft.AspNetCore.Mvc;
using System.Text.Json;

namespace httponly.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class UsuarioController : ControllerBase
    {

        // Diccionario para guardar usuarios en memoria
        private static readonly Dictionary<string, UsuarioDTO> usuarios = new();


        // 1.a - Guardar un solo campo
        [HttpPost("Registrar_1.1")]
        public IActionResult RegistrarUsuario([FromBody] UsuarioDTO usuarioDTO)
        {
            if(usuarioDTO == null || string.IsNullOrEmpty(usuarioDTO.Apodo))
                return BadRequest();

            // Guardar el apodo en la sesión
            HttpContext.Session.SetString("Apodo", usuarioDTO.Apodo);

            // Guardar el usuario en el diccionario
            usuarios[usuarioDTO.Apodo] = usuarioDTO;

            return Ok(new { message = "Usuario registrado correctamente" });
        }

        // 1.b .- Obtiene los datos por el apodo
        [HttpGet("ObtenerDatosPorApodo_1.2")]
        public IActionResult ObtenerDatosPorApodo1(string apodo)
        {
            // Verificar sesión
            string apodoSesion = HttpContext.Session.GetString("Apodo");

            if (apodoSesion == null || apodoSesion != apodo)
                return BadRequest("Usuario no encontrado");

            // Verificar si el usuario existe
            if (!usuarios.ContainsKey(apodo))
                return NotFound("Usuario no encontrado");

            // Devolver datos del usuario
            return Ok(usuarios[apodo]); // usuario[apodo] es un objeto
        }

        // 2.- Guardar varios campos
        [HttpPost("Registrar_2.1")]
        public IActionResult RegistrarMultiples([FromBody] UsuarioDTO usuarioDTO)
        {
            if (usuarioDTO == null || 
                string.IsNullOrEmpty(usuarioDTO.Apodo) ||
                string.IsNullOrEmpty(usuarioDTO.Nombre) || 
                string.IsNullOrEmpty(usuarioDTO.Oficio))
                return BadRequest();

            // Guardar el apodo en la sesión
            HttpContext.Session.SetString("Apodo", usuarioDTO.Apodo);
            HttpContext.Session.SetString("Nombre", usuarioDTO.Nombre);
            HttpContext.Session.SetString("Oficio", usuarioDTO.Oficio);

            // Guardar el usuario en el diccionario
            usuarios[usuarioDTO.Apodo] = usuarioDTO;

            return Ok(new { message = "Usuario registrado correctamente" });
        }


        // 2.- Guardar varios campos
        [HttpGet("ObtenerDatosPorApodo_2.2")]
        public IActionResult ObtenerDatosPorApodo2()
        {
            // Verificar sesión
            string apodoSesion = HttpContext.Session.GetString("Apodo");
            string nombreSesion = HttpContext.Session.GetString("Nombre");
            string oficioSesion = HttpContext.Session.GetString("Oficio");

            if (apodoSesion == null || nombreSesion == null || oficioSesion == null)
                return BadRequest("No se han encontrado todos los datos");

            // Devolver solo lo que está en la sesión
            var datosSesion = new
            {
                Apodo = apodoSesion,
                Nombre = nombreSesion,
                Oficio = oficioSesion
            };

            // Devolver datos del usuario
            return Ok(datosSesion); // usuario[apodo] es un objeto
        }

        // Guardar datos en un JSON
        [HttpPost("RegistrarConJSON_3.1")]
        public IActionResult RegistrarConJSON([FromBody] UsuarioDTO usuarioDTO)
        {
            if (usuarioDTO == null ||
                string.IsNullOrEmpty(usuarioDTO.Apodo) ||
                string.IsNullOrEmpty(usuarioDTO.Nombre) ||
                string.IsNullOrEmpty(usuarioDTO.Oficio))
                return BadRequest();

            // Guardar todo el objeto como JSON en la sesión
            var usuarioJson = JsonSerializer.Serialize(usuarioDTO);
            HttpContext.Session.SetString("Usuario", usuarioJson);

            // Guardar el usuario en el diccionario (opcional, si lo necesitas)
            usuarios[usuarioDTO.Apodo] = usuarioDTO;

            return Ok(new { message = "Usuario registrado correctamente" });
        }

        // Devuelve los tres campos que hay en la cookie
        [HttpGet("ObtenerUsuarioSesion_3.2")]
        public IActionResult ObtenerUsuarioSesion()
        {
            // Recuperar el JSON de la sesión
            string usuarioJson = HttpContext.Session.GetString("Usuario");

            if (string.IsNullOrEmpty(usuarioJson))
                return NotFound("No hay datos de usuario en la sesión");

            // Deserializar JSON a objeto UsuarioDTO
            var usuario = JsonSerializer.Deserialize<UsuarioDTO>(usuarioJson);

            return Ok(usuario);
        }

    }
}
~~~
