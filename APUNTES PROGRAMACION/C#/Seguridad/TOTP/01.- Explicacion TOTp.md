# TOTP (Verificación en dos pasos)
## TOTP `Time-based One-Time Password`
- Es un algoritmo que genera contraseñas de un solo uso (`OTP`), que caducan cada pocos segundos (normalmente 30 segundos)
- `TOTP` está definido en el estándar RFC 6238, y los usan apps como:
    - Microsoft Authenticator
    - Google Authenticator
    - Authy
    - FreeOTP, ...
- Cuando decimos "añadir 2FA con Microsoft Authenticator", se está implementando 2FA mediante TOTP
- Cada código se calcula con:
    ~~~csharp
    TOTP = función(HMAC-SHA1, secreto, tiempo_actual / 30s)
    ~~~
- TOTP es una de las formas más comunes de implementar 2FA
- Pero 2FA puede hacerse con muchos métodos:

| Método 2FA | Tipo | Requiere TOTP |
|---|---|---|
| SMS con códido | Algo que tienes (teléfono) | ❌ No usa TOTP |
| App Authenticator (Google, Microsoft, ...) | Algo que tienes | ✅ Usa TOTP |
| Token físico (YubiKey, FIDO2) | Algo que tienes | ❌ Usa otros protocolos |
| Email con enlace | Algo que tienes | ❌ No usa TOTP |

## ¿Qué es exactamente un "secreto TOTP"?
- Es una clave privada compartida entre el backend y la app Authenticator
    - Esa clave es una secuencia de bytes aleatorios (por ejemplo, 20 bytes)
    - El backend la guarda asociada al usuario
    - El usuario la introduce o escanea en su app Authenticator
    - A partir de esa clave, ambos (app y backend) generan el mismo código de 6 dígitos cada 30 segundos (sin conexión entre ellos)

## Objetivo de la primera parte
- Crear un backend con: 
    - Un endpoint `/register`: crea usuario y genera un secreto TOTP
    - Un endpoint `/verify-setup`: sirve para probar que el código TOTP generado por Authenticator coincide
    - Un endpoint `/login`: pide usuario y contraseña
    - Un endpoint `/verify-2fa`: valida el código 2FA para entrar en la app
- Usaremos C# + ASP.NET Core Web Api y la librería Otp.Net para generar y validar los códigos TOTP

## Paso 1.- Instalar la librería Otp.Net
- En el proyecto de backend
    ~~~bash
    dotnet add package Otp.Net
    ~~~

## Paso 2.- Crear un modelo de usuario sencillo
- Para este ejemplo, no necesitamos base de datos todavía
- Simularemos una lista estática en memoria
- Se crea un archivo `Models/User.cs`
    ~~~csharp
    namespace MyApp.Models
    {
        public class User
        {
            public string Username { get; set; } = string.Empty;
            public string Password { get; set; } = string.Empty; // En producción se guarda hasheada
            public string TwoFactorSecret { get; set; } = string.Empty;
        }
    }
    ~~~

- Se crea un dto `Dto/VerifyUserDTO.cs`
    ~~~csharp
    namespace TOTPapp.DTO
    {
        public class VerifyUserDTO
        {
            public string Usename { get; set; } = string.Empty;
            public string Code { get; set; } = string.Empty;
        }
    }
    ~~~

## Paso 3.- Crear un controlador `AuthController`
- Creamos `Controllers/AuthController.cs`
    ~~~csharp
    using Microsoft.AspNetCore.Mvc;
    using OtpNet;
    using MyApp.Models;
    using System.Text;

    namespace MyApp.Controllers
    {
        [ApiController]
        [Route("api/[controller]")]
        public class AuthController : ControllerBase
        {
            // Simulamos una base de datos
            private static List<User> Users = new();

            // 1️⃣ Registro de usuario y generación de secreto TOTP
            [HttpPost("register")]
            public IActionResult Register([FromBody] User user)
            {
                if (Users.Any(u => u.Username == user.Username))
                    return BadRequest("Usuario ya existe");

                // Generar secreto para TOTP
                var key = KeyGeneration.GenerateRandomKey(20);
                var base32Secret = Base32Encoding.ToString(key);
                user.TwoFactorSecret = base32Secret;

                Users.Add(user);

                // Crear URL para usar con Authenticator (URI estándar otpauth)
                var issuer = Uri.EscapeDataString("MiAppSegura");
                var account = Uri.EscapeDataString(user.Username);
                var qrUri = $"otpauth://totp/{issuer}:{account}?secret={base32Secret}&issuer={issuer}&digits=6";

                return Ok(new
                {
                    message = "Usuario registrado",
                    secret = base32Secret,
                    qrUri
                });
            }

            // 2️⃣ Verificar que la app Authenticator genera códigos correctos (opcional)
            [HttpPost("verify-setup")]
            public IActionResult VerifySetup([FromBody] VerifyUserDTO data)
            {
                string username = data.Username;
                string code = data.Code;

                var user = Users.FirstOrDefault(u => u.Username == username);
                if (user == null)
                    return NotFound("Usuario no encontrado");

                var totp = new Totp(Base32Encoding.ToBytes(user.TwoFactorSecret));
                bool isValid = totp.VerifyTotp(code, out _, VerificationWindow.RfcSpecifiedNetworkDelay);

                return Ok(new { valid = isValid });
            }

            // 3️⃣ Login con usuario y contraseña
            [HttpPost("login")]
            public IActionResult Login([FromBody] User user)
            {
                var found = Users.FirstOrDefault(u => u.Username == user.Username && u.Password == user.Password);
                if (found == null)
                    return Unauthorized("Credenciales inválidas");

                return Ok(new { requires2FA = true });
            }

            // 4️⃣ Verificar código 2FA
            [HttpPost("verify-2fa")]
            public IActionResult Verify2FA([FromBody] VerifyUserDTO data)
            {
                string username = data.Username;
                string code = data.Code;

                var user = Users.FirstOrDefault(u => u.Username == username);
                if (user == null)
                    return NotFound("Usuario no encontrado");

                var totp = new Totp(Base32Encoding.ToBytes(user.TwoFactorSecret));
                bool isValid = totp.VerifyTotp(Code, out _, VerificationWindow.RfcSpecifiedNetworkDelay);

                if (!isValid)
                    return Unauthorized("Código incorrecto");

                return Ok(new { success = true, message = "Autenticación completada" });
            }
        }
    }
    ~~~
## Endpoints necesarios

- 1.- `POST /api/auth/register`
    - Propósito: crear un usuario de prueba y generar el secreto TOTP que vas a añadir en la app (Microsoft/Google Authenticator) en formato QR
    - Entrada (body JSON)
        ~~~json
        {
        "username": "david",
        "password": "1234"
        }
        ~~~
        *(En el ejemplo se guarda la contraseña sin hash)*
    - Qué hace paso a paso
        - Comprueba si ya existe un usuario con `Users.Any(u => u.Username == user.Username)`
            - Si existe: devuelve `404 Bad Request` con mensaje `"Usuario ya existe"`
        - Si no existe:
            - Genera una clave secreta aleatoria: `KeyGeneration.GenerateRandomKey(20)` (20 bytes)
            - Convierte esa clave a texto en formato Base32: `Base32Encoding.ToString(key)` -> ese es el `secret` que van a usar las apps Authenticator (las Authenticator apps usan este formato)
            - Asigna `user.TwoFactorSecret = base32secret`
            - Añade `user` a la lista en memoria `Users.Add(user)`
        - Genera la URI de provisioning compatible con Authenticator, que es la URI de configuración TOTP estándar (formato `otpauth://totp/...`), por ejemplo:
            ~~~ruby
            otpauth://totp/MiAppSegura:david?secret=JBSWY3DPEHPK3PXP&issuer=MiAppSegura&digits=6
            ~~~
            - `MiAppSegura` es el nombre de la aplicación (issuer)
            - `david` es el usuario (account name)
            - `secret` es el secreto Base32
            - `digits=6` indica que los códigos son de 6 dígitos 
            - Esta URI la puede escanear la app directamente (QR) o puedes dar al usuario la clave manual (`secret`)
            - Cuando escaneamos ese QR, la app entiende:
                - "Ah, este usuario tiene una cuenta en MiAppSegura y su secreto es XXX"
            - Entonces, esa app generará los mismos códigos que el backend

    - Respuesta (200 OK)
        ~~~json
        {
            "message": "Usuario registrado",
            "secret": "JBSWY3DPEHPK3PXP",
            "qrUri": "otpauth://totp/MiAppSegura:david?secret=JBSWY3DPEHPK3PXP&issuer=MiAppSegura&digits=6"
        }
        ~~~
    - Errores posibles
        - 400 Bad Request si el usuario ya existe
    - Notas
        - Para ver el QR en el navegador (imagen)
            - `api.qrserver.com` es una herramienta visual para generar el código QR que puedes escanear desde el móvil. En `URI_ENCODEADA` se le pasa la qrUri generada (https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={URI_ENCODEADA})
            - Ej. en JS: `encodeURIComponent(qrUri)`
            - Quedaría así: https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=otpauth://totp/MiAppSegura:david?secret=IIRIMGEZEGQV5RVTREUMP2FZBH6FTCD7&issuer=MiAppSegura&digits=6
        - Esta URL nos mostrará el código QR generado
    - Resumen
        - Registra un nuevo usuario (con su usuario y contraseña)
        - Genera un secreto TOTP único para ese usuario, que luego se añadirá en una app como Microsoft Authenticator o Google Authenticator
    
- 2.- `POST api/auth/login`
    - Comprueba si el usuario está registrado
        - Si está registrado, debe introducir el código de 6 dígitos que genera la app Authenticator

- 3.- `POST api/auth/verify-2fa`
    - El usuario debe introducir el código que genera la app Authenticator
    - Qué hace
        ~~~csharp
        var totp = new Totp(Base32Encoding.ToBytes(user.TwoFactorSecret));
        bool isValid = totp.VerifyTotp(Code, out _, VerificationWindow.RfcSpecifiedNetworkDelay);
        ~~~
        - `new Totp(Base32Encoding.ToBytes(user.TwoFactorSecret))`
            - Se crea un objeto TOTP (Time-based One-Time Password) usando la librería `OptNet`
            - `user.TwoFactorSecret`: es la clave secreta (en Base32) que se generó cuando el usuario activó el 2FA
            - `Base32Encoding.ToBytes(...)`: la convierte a bytes, porque el algoritmo TOTP trabaja internamente con bytes
            - `new Totp(...)`: crea un generador TOTP que sabe calcular el código válido basado en el tiempo actual (normalmente cada 30 segundos)
            - En resumen, está preparando el generador TOTP para poder comparar el código que el usuario te envía con el que debería ser válido en este momento exacto
        - `totp.VerifyTotp(Code, out _, VerificationWindow.RfcSpecifiedNetworkDelay)`
            - Se verifica si el código introducido por el usuario (`Code`) es correcto
            - `Code`: el número de 6 dígitos que el usuario escribió desde su app (Google Authenticator, Authy, ...)
            - `out_`: el método devuelve también el "tiempo de paso" (step) usado, pero tú no lo necesitas, así que lo descartas con `_`
            - `VerificationWindow.RfcSpecifiedNetworkDelay`: permite un pequeño margen de tiempo (unos segundos antes y después del actual) para tolerar diferencias entre relojes
            - El método devuelve un booleano (`true` or `false`)
                - `true`: el código es válido
                - `false`: el código es incorrecto o ha expirado

## Parte del FrontEnd
- Resumen
    - Si lo datos introducidos son correctos:
        ~~~js
        const res = await fetch("/api/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ Username: regUser, Password: regPass }),
        });
        const data = await res.json();

        if (data.qrUri) {
            setRegMsg("Usuario registrado. Escanea el QR en Authenticator");
            setQrUri(data.qrUri); // Se genera el código QR
            setRegUser("");
            setRegPass("");
            setRegPassConfirm("");
        } else {
            setRegMsg(data.message || "Error en el registro");
        }
        ~~~

- Ejemplo Completo del FrontEnd
    ~~~js
    import React, { useState } from "react";
    import { useNavigate } from "react-router-dom";

    export default function AuthPage() {
        // ----- Registro -----
        const [regUser, setRegUser] = useState("");
        const [regPass, setRegPass] = useState("");
        const [regPassConfirm, setRegPassConfirm] = useState("");
        const [regMsg, setRegMsg] = useState("");
        const [qrUri, setQrUri] = useState("");

        // ----- Login -----
        const [loginUser, setLoginUser] = useState("");
        const [loginPass, setLoginPass] = useState("");
        const [loginMsg, setLoginMsg] = useState("");
        const [requires2FA, setRequires2FA] = useState(false);

        // ----- 2FA -----
        const [code2FA, setCode2FA] = useState("");
        const [msg2FA, setMsg2FA] = useState("");

        // ----- Navigate -----
        const navigate = useNavigate();

        // ---------------- Registro ----------------
        const handleRegister = async (e) => {
            e.preventDefault();
            if (!regUser || !regPass || !regPassConfirm) {
                setRegMsg("Todos los campos son obligatorios");
                return;
            }
            if (regPass !== regPassConfirm) {
                setRegMsg("Las contraseñas no coinciden");
                return;
            }

            try {
                const res = await fetch("/api/auth/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ Username: regUser, Password: regPass }),
                });
                const data = await res.json();

                if (data.qrUri) {
                    setRegMsg("Usuario registrado. Escanea el QR en Authenticator");
                    setQrUri(data.qrUri);
                    setRegUser("");
                    setRegPass("");
                    setRegPassConfirm("");
                } else {
                    setRegMsg(data.message || "Error en el registro");
                }
            } catch (error) {
                setRegMsg("Error conectando al servidor");
                console.error(error);
            }
        };

        // ---------------- Login ----------------
        const handleLogin = async (e) => {
            e.preventDefault();

            if (!loginUser || !loginPass) {
                setLoginMsg("Todos los campos son obligatorios");
                return;
            }

            try {
                const res = await fetch("/api/auth/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ Username: loginUser, Password: loginPass }),
                });

                // Si el status no es OK, leer el texto en vez de JSON
                if (!res.ok) {
                    const text = await res.text();
                    setLoginMsg(text);
                    return;
                }

                const data = await res.json();

                if (data.requires2FA) {
                    setLoginMsg("Usuario correcto. Introduce el código 2FA");
                    setRequires2FA(true);
                } else {
                    setLoginMsg("Login exitoso");
                }
            } catch (error) {
                setLoginMsg("Error conectando al servidor");
                console.error(error);
            }
        };

        // ---------------- Verificar 2FA ----------------
        const handle2FA = async (e) => {
            e.preventDefault();
            if (!code2FA) {
                setMsg2FA("Introduce el código de 6 dígitos");
                return;
            }

            try {
                const res = await fetch("/api/auth/verify-2fa", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ Username: loginUser, Code: code2FA }),
                });
                const data = await res.json();

                if (data.success) {
                    setMsg2FA("Autenticación completada ✅");
                    setRequires2FA(false);
                    setLoginUser("");
                    setLoginPass("");
                    setCode2FA("");
                    setLoginMsg("");
                    navigate("/Inicio");
                } else {
                    setMsg2FA("Código incorrecto ❌");
                }
            } catch (error) {
                setMsg2FA("Error conectando al servidor");
                console.error(error);
            }
        };

        return (
            <div className="auth-page">
                {/* ===== Registro ===== */}
                <form onSubmit={handleRegister}>
                    <h2>Registro</h2>
                    <input
                        type="text"
                        placeholder="Usuario"
                        value={regUser}
                        onChange={(e) => setRegUser(e.target.value)}
                    />
                    <input
                        type="password"
                        placeholder="Contraseña"
                        value={regPass}
                        onChange={(e) => setRegPass(e.target.value)}
                    />
                    <input
                        type="password"
                        placeholder="Confirmar contraseña"
                        value={regPassConfirm}
                        onChange={(e) => setRegPassConfirm(e.target.value)}
                    />
                    <button type="submit">Registrarse</button>
                    {regMsg && <p>{regMsg}</p>}
                </form>

                {/* Mostrar QR después del registro */}
                {qrUri && (
                    <div>
                        <h3>Escanea este QR en Authenticator</h3>
                        <img
                            src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(
                                qrUri
                            )}`}
                            alt="QR TOTP"
                        />
                    </div>
                )}

                {/* ===== Login ===== */}
                {!requires2FA && (
                    <form onSubmit={handleLogin}>
                        <h2>Login</h2>
                        <input
                            type="text"
                            placeholder="Usuario"
                            value={loginUser}
                            onChange={(e) => setLoginUser(e.target.value)}
                        />
                        <input
                            type="password"
                            placeholder="Contraseña"
                            value={loginPass}
                            onChange={(e) => setLoginPass(e.target.value)}
                        />
                        <button type="submit">Entrar</button>
                        {loginMsg && <p>{loginMsg}</p>}
                    </form>
                )}

                {/* ===== Verificación 2FA ===== */}
                {requires2FA && (
                    <form onSubmit={handle2FA}>
                        <h2>Verificación 2FA</h2>
                        <input
                            type="text"
                            placeholder="Código de 6 dígitos"
                            value={code2FA}
                            onChange={(e) => setCode2FA(e.target.value)}
                        />
                        <button type="submit">Verificar</button>
                        {msg2FA && <p>{msg2FA}</p>}
                    </form>
                )}
            </div>
        );
    }

    ~~~
    


