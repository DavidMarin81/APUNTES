# HttpContext.Session
## ¿Qué es `HttpContext.Session`
- `HttpContext.Session` es una propiedad que se encuentra en aplicaciones web desarrolladas con ASP.NET Core que te permite almacenar datos del usuario de manera temporal mientras dura su sesión en la aplicación web
- En otras palabras:
    - Es un contenedor de datos que pertenece a un usuario específico
    - Los datos solo existen mientras la sesión está activa. Si el usuario cierra el navegador o la sesión expira, los datos se pierden
    - Se usa para guardar información entre diferentes peticiones HTTP
        - Recuerda que HTTP es stateless: cada petición es independiente, y `Session` sirve para "recordar" cosas entre peticiones

## ¿Cómo funciona a grandes rasgos?
- Cuando un usuario entra en tu aplicación web, se crea una sesión única para él
- La aplicación asigna un `ID de sesión`(normalmente una cookie llamada `ASP.NET_SessionId`)
- `HttpContext.Session` permite guardar datos clave-valor en esa sesión usando ese ID
- Cada vez que el usuario hace otra petición, ASP.NET Core puede recuperar los datos de la sesión usando ese 

    | Usuario | Sesión ID | Datos en sesión |
    | --- | --- | --- |
    | Ana | 1234 | {"Carrito": ["Libro"]} |
    | Juan | 5678 | {"Carrito": ["Lapiz"]} |

- Cada usuario tiene su propia sesión y sus datos no se mezclan

## ¿Para qué sirve?
- `HttpContext.Session` es útil para:
    - Guardar información del usuario mientras navega por la web, por ejemplo:
        - Nombre del usuario logueado
        - Carrito de compras
        - Preferencias temporales (tema oscuro, idioma)
    - Evitar consultas constantes a la base de datos para datos que solo necesitan persistir durante la sesión
    - Mantener estados en aplicaciones web, dado que HTTP no mantiene estado por sí mismo

## ¿Cómo se utiliza?
- En ASP.NET Core, antes de usar `Session`, debes configurarla en tu proyecto
- Paso 1: Configurar servicios en `Program.cs` o `Startup.cs`
    ~~~csharp
    // En Program.cs (ASP.NET Core 6+)
    var builder = WebApplication.CreateBuilder(args);

    // Añadir servicios de sesión
    builder.Services.AddDistributedMemoryCache(); // Cache en memoria
    builder.Services.AddSession(options =>
    {
        options.IdleTimeout = TimeSpan.FromMinutes(30); // Tiempo de vida de la sesión
        options.Cookie.HttpOnly = true; // No accesible desde JS
        options.Cookie.IsEssential = true;
    });

    var app = builder.Build();

    app.UseSession(); // Habilitar sesión

    app.MapGet("/", () => "Hola Mundo");

    app.Run();
    ~~~

    - 1.1.- Crear el builder
        ~~~csharp
        var builder = WebApplication.CreateBuilder(args);
        ~~~
        - `WebApplication.CreateBuilder(args)` crea el constructor de tu aplicación
        - Este `builder` es el que prepara todos los servicios y configuraciones antes de que la aplicación empiece a escuchar peticiones
        - Piensa en él como el "lienzo en blanco" donde vas a añadir las herramientas que tu app necesita (como sesión, base de datos, autenticación, ...)
    - 1.2.- Añadir la memoria distribuida
        ~~~csharp
        builder.Services.AddDistributedMemoryCache();
        ~~~
        - `AddDistributedMemoryCache()` configura un almacenamiento en memoria para la sesión
        - La sesión necesita algún sitio donde guardar temporalmente los datos de cada usuario
        - Más adelante, podrías usar Redis o SQL Server si quieres que la sesión persiste en varios servidores
        - Sin esto, `Session` no tendría donde guardar nada
    - 1.3.- Añadir el servicio de sesión
        ~~~csharp
        builder.Services.AddSession(options =>
        {
            options.IdleTimeout = TimeSpan.FromMinutes(30);
            options.Cookie.HttpOnly = true;
            options.Cookie.IsEssential = true;
        });
        ~~~
        - Esto habilita la sesión en tu aplicación y te permite configurarla:
            - `IdleTimeout = TimeSpan.FromMinutes(30)`
                - Indica cuánto tiempo puede estar inactiva la sesión antes de expirar
                - Si el usuario no hace ninguna petición en 30 minutos, se eliminan los datos de la sesión
                - Se puede ajustar según tus necesidades (ej. 10 min, 1 hora, ...)
            - `Cookie.HttpOnly = true`
                - La sesión se identifica con una cookie(`ASP.NET_SessionId`)
                - `HttpOnly` evita que JavaScript del navegador pueda leerla, mejorando la seguridad
            - `Cookie.IsEssentia = true`
                - Marca la cookie como esencial para la aplicación
                - Esto es útil para cumplir la ley de cookies (GDPR), asegurando que la sesión funciona aunque el usuario no acepte cookies no esenciales
    - 1.4.- Construir la aplicación
        ~~~csharp
        var app = builder.Build();
        ~~~
        - `builder.Build()` ensambla todo lo que configuraste en un objet `app`
        - Ahora `app` es la aplicación web real que va a recibir peticiones
        - Antes de ejecutarla, debes habilitar middleware y rutas
    - 1.5.- Habilitar middleware de sesión
        ~~~csharp
        app.UseSession();
        ~~~
        - `useSession()` agrega un middleware en la tubería de ASP.NET Core
        - Middleware = código que se ejecuta antes y después de cada petición HTTP
        - Sin esto, aunque configures `AddSession`, no podrás usar `HttpContext.Session`
        - Es obligatorio ponerlo antes de cualquier código que quiera acceder a la sesión
        - Piensa que el middleware de sesión "carga" la sesión del usuario y la "guarda" al final de la petición
    - 1.6.- Resto de código
        ~~~csharp
        app.MapGet("/", () => "Hola Mundo");
        ~~~
        - Esto solo define una ruta de ejemplo que devuelve texto
        - En tu aplicación real, aquí van tus controladores, endpoints o páginas
        ~~~csharp
        app.Run();
        ~~~
        - Inicia la aplicación web y comienza a escuchar peticiones
        - Sin esto, tu app no funcionaría
